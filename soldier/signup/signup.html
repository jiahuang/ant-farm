<!DOCTYPE html>
<html>
  <head>
    <title>Sign Up For Expo Live</title>
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
      <div class="span6 right-divider" id="registered-container">
        <h2>Pre-Registered</h2>
        <form class="form-search">
          <input type="text" class="input-medium search-query" id="registered-users-search">
          <a class="btn" id="clear-search-button" onclick="clearRegisteredUsersTableAndSearch($('#registered-users-table'), $('#registered-users-search'), current_registered_table_array, unsynced_registered_users)">Clear</a>
        </form>
        <div id="table-container">
          <table class="table" id="registered-users-table">
          </table>
        </div>
      </div>
      <div class="span5">
        <h2>Recently Added</h2>
        <form class="form-search">
          <input type="text" class="input-medium search-query" id="recent-users-search">
          <a class="btn" id="clear-search-button" onclick="clearRegisteredUsersTableAndSearch($('#recent-users-table'), $('#recent-users-search'), current_recent_table_array, recent_users)">Clear</a>
        </form>
        <div id="table-container">
          <table class="table" id="recent-users-table">
          </table>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="span12" id="selected-user-container" style="text-align:center;">
        <h3>Selected User: <span id="selected-user-span">None<span></h3>
      </div>
    </div>
    <div class="row" id="ant-select-container">
      <div class="span12">
        <h2>Ants</h2>
            <select id="ant_select_box"></select>
        </h2>
      </div>
    </div>
    <div class="row" id="sync-button">
        <div class="span4">
            <a id="sync-user" class="btn btn-green btn-large btn-success active"  data-link="modal" data-target="#signup-modal" style="position:relative; top:50px;">Sync User</a>
        </div>
    </div>
    <div class="row">
      <div class="span12">
         <div id="dialog"><h2 id="sync-text">Sync Succesful</h2></div>
      </div>
    </div>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script>

    var users = [];
    var ants = [];
    var unsynced_registered_users = [];
    var synced_registered_users = [];
    var recent_users = []
    var unsynced_ants = [];
    var synced_ants = [];


    var selected_user;

    var current_registered_table_array = [];
    var current_recent_table_array = [];
    var selected_table_array;

    function load_users() {

      $.getJSON('http://api.olinexpo.com/users/', function (data, successflag) {
        users = data;
        var user_table = $('#registered-users-table');

          if (!successflag) {
            console.log("Error: No user data was returned");
            return;
          }

          extract_user_sync_state();
          updateTableWithUsers($('#registered-users-table'), unsynced_registered_users);
      });
    }

    function new_recent_user(user) {
      recent_users.push(user);
      updateTableWithUsers($('#recent-users-table'), recent_users);
    }

    function extract_ant_sync_state() {
    if (ants) {
      $.each(ants, function(index, ant) {
        if (!ant.user) {
          unsynced_ants.push(ant);
        }  
        else {
          synced_ants.push(ant);
          synced_registered_users.push(ant.user);
        }
      });
    }
  }

    function extract_user_sync_state() {
      if (ants && users) {}
        $.each(users, function(index, user) {
          if (synced_registered_users.indexOf(user.id.toString()) == -1) {
              unsynced_registered_users.push(user);
          }
      });
     }

    $('#registered-users-search').on('keyup', function () {

      searchTableForCellsMatchingTermInSearchBar($('#registered-users-table'), $('#registered-users-search').val().toLowerCase(), users);
    });

    $('#recent-users-search').on('keyup', function () {

      searchTableForCellsMatchingTermInSearchBar($('#recent-users-table'), $('#recent-users-search').val().toLowerCase(), recent_users);
    });

    function searchTableForCellsMatchingTermInSearchBar(user_table, filter_term, user_list) {
        var filtered_users = [];

        if (!filter_term) {
          updateTableWithUsers(user_table, user_list);
          return;
        } 

        $.each(user_list, function(index, user) {

          if (user.name && user.name.toLowerCase().indexOf(filter_term) !== -1) {
              filtered_users.push(user);
          }
        });

        updateTableWithUsers(user_table, filtered_users);
    }

    function clearRegisteredUsersTableAndSearch(user_table, user_search, table_array, new_table_array) {
      user_search.val("");

      if ($.each(table_array, (function(index, val) { if (val == selected_user) return false; } ) ) ) {
        $('#selected-user-span').text("None");
        $('#ant-select-container').fadeOut();
      }
      updateTableWithUsers(user_table, new_table_array);
    }

    
    function tableRowClicked() {

      var new_selection = $(this).data();

      selected_table_array = ($(this).parent().parent().id == 'registered-users-table') ? current_registered_table_array : current_recent_table_array;

      var same = false;

      $('.table-row-selected').each(function(index, row) { 
          $(row).removeClass('table-row-selected');
      });

      if (new_selection != selected_user) {

        $(this).addClass("table-row-selected");

        selected_user = new_selection;

        $('#selected-user-span').text(selected_user.name);

        $('#ant-select-container').fadeIn();

      } else {
        selected_user = null;

        $('#selected-user-span').text("None");

        $('#ant-select-container').fadeOut();
      }
    }

    function updateTableWithUsers(user_table, users_to_table) {

        if (user_table[0] == $('#registered-users-table')[0]) {
            current_registered_table_array = users_to_table;
        } else {
            current_recent_table_array = users_to_table;
        }
        user_table.empty();

        var header = $('<thead></thead>');
        var header_first = $('<th></th>').text("First Name");
        var header_last = $('<th></th>').text("Last Name");
        header.append(header_first, header_last);
        user_table.append(header);


        $.each(users_to_table, function(index, user) {
          if (user.name) {
            var row = $('<tr></tr>').addClass('table-row').click(tableRowClicked);
            var firstname = $('<td></td>').text(user.name.split(" ")[0]);
            var lastname = $('<td></td>').text(user.name.split(" ")[1]);
            $(row).data(user);
            row.append(firstname, lastname);
            user_table.append(row);
          }
        });
    }

    function load_ants() {
        $.getJSON('http://api.olinexpo.com/ants/', function (data, successflag) {
        ants = data;
        extract_ant_sync_state();
        var select_box = $('#ant_select_box');
        var item = $('<option></option>').text("None");
        select_box.append(item);

        if (!successflag) {
          console.log("Error: No ant data was returned");
          return;
        }

        $.each(ants, function(index, value) {
          var item = $('<option></option>').val(value.id).text(value.id);
          select_box.append(item);
        });

        load_users();
      });
    }

    $('#sync-user').click(function() {

       $.ajax({
        type: 'PUT',
        url: 'http://api.olinexpo.com/ants/' + $('#ant_select_box').val() ,
        data: {
          user:parseInt(selected_user.id)
        },
        success: function (ret, successflag) {
          if (successflag) {
            $('#sync-text').text("Sync succesful").css("color", "green");

          } else {
            $('#sync-text').text("Sync FAILED").css("color", "red");
          }

          $("#dialog").show();

          setTimeout(function() {
              window.location.reload();
            }, 1000);
        }
      })
    });

    $('#ant_select_box').change(function() {
      if ($('#ant_select_box option:selected').text() == "None") {
        $('#sync-button').fadeOut();
      }
      else {
        $('#sync-button').fadeIn();
      }

    });

    function set_button_state() {
      if ($('#selected_user').text() == "" && $('#selected_ant').text() == "") {
          $('#sync-user').removeClass('disabled');
      } else {
          $('#sync-user').addClass('disabled');
      }
    }

    $(load_ants);
    $(new_recent_user({"id" : 213432, "name" : "Georgey Boy"}));
    $(new_recent_user({"id" : 4325, "name" : "Goergonia Toobe"}));
    $(new_recent_user({"id" : 54365, "name" : "Jon Crank"}));
    $(new_recent_user({"id" : 4324567, "name" : "Doobi Brothers"}));
    $(new_recent_user({"id" : 54322, "name" : "Thonas Tank"}));
    $(new_recent_user({"id" : 432432, "name" : "Bleep Boy"}));

  
    </script>
    <style>

    #dialog { display: none; position: relative; left: 500px; top:-50px; }â€‹

    #selected-user-center { text-align: center; }

    #selected-user-container {  
      border-bottom-width: 1px;
      border-bottom-color:#888;
      border-bottom-style:solid;
    }

    #table-container {
      height:215px;
      overflow: scroll;
      -moz-box-shadow: inset 0 0 0px 5px #888;
      -webkit-box-shadow: inset 0 0 0px 5px#888;
      box-shadow: inset 0 0 5px 0px #888;
    }
    .table-row-selected {
      background-color: #888;
    }
    .table-row:hover {
      background-color: #888
    }
      .right-divider{
        padding-right: 15px;
        border-right-width: 1px;
        border-right-color:#888;
        border-right-style:solid;
      }
    #recent-container {
      margin-top: 30px;
      height:215px;
      overflow: scroll;
      -moz-box-shadow: inset 0 0 0px 5px #888;
      -webkit-box-shadow: inset 0 0 0px 5px#888;
      box-shadow: inset 0 0 5px 0px #888;
    }
    #ant-select-container {
      display: none;
    }
    #sync-button {
      display: none;
    }
    </style>
    </div> 
  </body>
</html>